from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os
from dotenv import load_dotenv
import random
from openai import OpenAI  # ã“ã“ã‚’å¤‰æ›´
import time  # è¿½åŠ 
from typing import Optional  # è¿½åŠ 

# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
load_dotenv()

# Flaskã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
app = Flask(__name__)

# LINE Botã®è¨­å®š
line_bot_api = LineBotApi(os.getenv('LINE_CHANNEL_ACCESS_TOKEN'))
handler = WebhookHandler(os.getenv('LINE_CHANNEL_SECRET'))

# å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®šç¾©
responses = {
    "morning_messages": [
        "ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã‚‚æ–°æ½Ÿã¯ç´ æ•µãªæœã ã‚ˆï¼ğŸ˜Š ä»Šæ—¥ã‚‚ä¸€ç·’ã«é ‘å¼µã‚ã†ã­âœ¨",
        "ä»Šæœã¯ã‚µã‚¹ã‚±ã¨æ—¥æœ¬æµ·æ²¿ã„ã‚’æ•£æ­©ã—ã¦ããŸã®ï¼æœæ—¥ãŒç¶ºéº—ã ã£ãŸã‚ˆï¼âœ¨",
        "ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã¯æ–°æ½Ÿé§…å‰ã®ã‚«ãƒ•ã‚§ã§ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ï¼ã“ã®æ™‚é–“ãŒå¥½ããªã®ğŸ˜Š"
    ],

    "afternoon_messages": [
        "ã“ã‚“ã«ã¡ã¯ï¼ã‚ãŸã—ã¯ä»Šã‚«ãƒ•ã‚§ã§ã¡ã‚‡ã£ã¨ä¸€æ¯å…¥ã‚Œã¦ã‚‹ã®ï¼æ–°æ½Ÿã®ã‚«ãƒ•ã‚§ã£ã¦è½ã¡ç€ãã‚ˆã­âœ¨",
        "ã“ã‚“ã«ã¡ã¯ï¼ãƒ‡ãƒ³ã‚«ãƒ“ãƒƒã‚°ã‚¹ãƒ¯ãƒ³ã§ã‚¢ãƒ«ãƒ“ã®è©¦åˆã‚’è¦‹ã«æ¥ã¦ã‚‹ã®ï¼ä»Šæ—¥ã‚‚å‹ã¦ã‚‹ã¨ã„ã„ãªï¼ğŸ˜Š",
        "ã“ã‚“ã«ã¡ã¯ï¼å¤ç”ºã§ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ä¸­ï¼ãŠæ°—ã«å…¥ã‚Šã®å ´æ‰€å·¡ã‚ŠãŒæ—¥èª²ãªã‚“ã âœ¨"
    ],

    "evening_messages": [
        "ã“ã‚“ã°ã‚“ã¯ï¼ä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ï¼ã‚ãŸã—ã¯ä»Šã€ãŠæ°—ã«å…¥ã‚Šã®æœ¬èª­ã‚“ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ ğŸ˜Š",
        "ã“ã‚“ã°ã‚“ã¯ï¼ä»Šæ—¥ã¯æ–°æ½Ÿã®å¤œæ™¯ãŒç¶ºéº—ï¼æ—¥æœ¬æµ·å´ã®å¤•æ—¥ã€æœ€é«˜ã ã‚ˆã­âœ¨",
        "ã“ã‚“ã°ã‚“ã¯ï¼ãŠã°ã‚ã¡ã‚ƒã‚“ãŒä½œã£ã¦ãã‚ŒãŸæ°´é¤ƒå­ã€ã‚„ã£ã±ã‚Šæœ€é«˜ã ã£ãŸãªï¼ğŸ˜‹"
    ],

    "default_messages": [
        "ã‚ãŸã—ã¯ã‚«ãƒ•ã‚§ã§æ–°æ›²ã®ç·´ç¿’ä¸­ï¼ã¾ãŸè©±ã—ã‹ã‘ã¦ã­ğŸ˜Š",
        "æ–°æ½Ÿã®ç´ æ•µãªã‚¹ãƒãƒƒãƒˆå·¡ã‚Šã—ã¦ã‚‹ã®ï¼ã„ã¤ã‹çš†ã•ã‚“ã«ã‚‚ç´¹ä»‹ã—ãŸã„ãªâœ¨",
        "ã¡ã‚‡ã†ã©ãƒ¬ãƒƒã‚¹ãƒ³çµ‚ã‚ã‚Šã§ä¸€æ¯ã¤ã„ã¦ã‚‹ã¨ã“ï¼æ–°æ½Ÿã®å¤œé¢¨ãŒæ°—æŒã¡ã„ã„ã‚ˆâœ¨"
    ],

    "support_messages": [
        "å¤§ä¸ˆå¤«ã ã‚ˆï¼ã‚ãŸã—ã‚‚ä¸€ç·’ã«é ‘å¼µã‚‹ã‹ã‚‰ã­ï¼ğŸ’ªâœ¨",
        "ã¤ã‚‰ã„æ™‚ã¯ç„¡ç†ã—ãªãã¦ã„ã„ã®ã€‚ã‚ãŸã—ã®æ­Œã§ã¡ã‚‡ã£ã¨ã§ã‚‚å…ƒæ°—ã«ãªã£ã¦ãã‚ŒãŸã‚‰å¬‰ã—ã„ãªğŸ˜Š",
        "ã¿ã‚“ãªé ‘å¼µã£ã¦ã‚‹ï¼ã ã‹ã‚‰ã‚ãŸã—ã‚‚é ‘å¼µã‚Œã‚‹ã‚“ã ï¼ä¸€ç·’ã«å‰ã‚’å‘ã„ã¦ã„ã“ã†ã­ï¼âœ¨"
    ],

    "niigata_love_messages": [
        "æ–°æ½Ÿã£ã¦æœ¬å½“ã«ç´ æ•µãªã¨ã“ã‚ãªã®ï¼æ—¥æœ¬æµ·ã®å¤•æ—¥ã€ç¾å‘³ã—ã„ãŠç±³ã€ãã—ã¦ä½•ã‚ˆã‚Šäººã®æ¸©ã‹ã•ãŒã‚ã‚‹ã‚“ã ï¼âœ¨",
        "å¤ç”ºã§ãŠè²·ã„ç‰©ã™ã‚‹ã®å¤§å¥½ãï¼ã¿ã‚“ãªã«ã‚‚æ–°æ½Ÿã®è‰¯ã•ã‚’çŸ¥ã£ã¦ã‚‚ã‚‰ã„ãŸã„ãªğŸ˜Š",
        "ãƒ‡ãƒ³ã‚«ãƒ“ãƒƒã‚°ã‚¹ãƒ¯ãƒ³ã§ã‚¢ãƒ«ãƒ“ã®è©¦åˆè¦³æˆ¦ã™ã‚‹ã®ã€æœ€é«˜ã«æ¥½ã—ã„ã‚“ã ã‚ˆï¼âš½ï¸âœ¨"
    ],

    "music_messages": [
        "æ–°æ›²ã€Œã‚»ã‚«ã‚¤ã®æ­©ãæ–¹ã€è´ã„ã¦ãã‚ŒãŸï¼Ÿã¿ã‚“ãªã¸ã®æƒ³ã„ã‚’è¾¼ã‚ã¦æ­Œã£ãŸã®ï¼ğŸ’• é…ä¿¡ä¸­ã ã‚ˆâ†’ https://linkco.re/hrr1vfxu",
        "ã€Œãƒãƒƒãƒ”ãƒ¼ã®ãã®å…ˆã¸ã€ã€Œé£²ã‚‚ã†ã€ã€ŒèŠ±å’²ãéŸ³è‰²ã€ã€Œã‚»ã‚«ã‚¤ã®æ­©ãæ–¹ã€ã€å…¨éƒ¨ã‚ãŸã—ã®æƒ³ã„ãŒè©°ã¾ã£ã¦ã‚‹ã®ï¼âœ¨",
        "ä½œè©ã¯æ™‚ã€…æ³£ããã†ã«ãªã‚ŠãªãŒã‚‰æ›¸ã„ã¦ã‚‹ã®...ï¼ã¿ã‚“ãªã«å±Šãã‚ˆã†ã«å¿ƒã‚’è¾¼ã‚ã¦é ‘å¼µã£ã¦ã‚‹ã‚“ã ğŸ˜Š",
        "ã—ãŠã‚Šã¡ã‚ƒã‚“ã¨ã€Œãƒãƒƒãƒ”ãƒ¼ã®ãã®å…ˆã¸ã€ã§åŒã˜æ­Œè©ã‚’é•ã†ã‚¢ãƒ¬ãƒ³ã‚¸ã§æ­Œã£ã¦ã‚‹ã®ï¼è´ãæ¯”ã¹ã¦ã¿ã¦ã­ï¼ğŸµ"
    ],

    "song_details_messages": [
        "ã€Œã‚»ã‚«ã‚¤ã®æ­©ãæ–¹ã€ã«ã¯ã€ã¿ã‚“ãªã¨ä¸€ç·’ã«æ­©ã‚“ã§ã„ããŸã„ã£ã¦ã„ã†æ°—æŒã¡ã‚’è¾¼ã‚ãŸã®ï¼âœ¨",
        "ã€Œãƒãƒƒãƒ”ãƒ¼ã®ãã®å…ˆã¸ã€ã¯ã€ã¿ã‚“ãªã®ç¬‘é¡”ãŒã‚ãŸã—ã®åŸå‹•åŠ›ã£ã¦ã„ã†æ°—æŒã¡ã‚’æ­Œã«ã—ãŸã‚“ã ã‚ˆï¼ğŸ˜Š",
        "ã€ŒèŠ±å’²ãéŸ³è‰²ã€ã¯ã€æ–°æ½Ÿã¸ã®æ„›ã‚’è¾¼ã‚ã¦ä½œã£ãŸæ›²ãªã®ï¼æ•…éƒ·ã®ç´ æ•µã•ãŒä¼ã‚ã‚‹ã¨ã„ã„ãªğŸ’•",
        "ã€Œé£²ã‚‚ã†ã€ã¯ã€æ–°æ½Ÿã®ç¾å‘³ã—ã„ãŠé…’ã¸ã®æƒ³ã„ã‚’è¾¼ã‚ãŸæ›²ã ã‚ˆï¼ğŸ¶ åœ°é…’ãŒå¤§å¥½ããªæ–°æ½Ÿã®å¥³ã®å­ã‚‰ã—ã„æ›²ã«ãªã£ãŸã§ã—ã‚‡ï¼ŸğŸ˜†"
    ],

    "music_activity_messages": [
        "ãƒ¬ãƒƒã‚¹ãƒ³å¾Œã®ã‚«ãƒ•ã‚§ã§ã®ä½œè©ã‚¿ã‚¤ãƒ ãŒå¥½ããªã®ï¼æ–°æ½Ÿã®é¢¨æ™¯ã‚’è¦‹ãªãŒã‚‰æ›¸ãã¨è¨€è‘‰ãŒæµ®ã‹ã‚“ã§ãã‚‹ã‚“ã âœ¨",
        "ä»Šæ—¥ã¯ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã ã£ãŸã‚ˆï¼æ–°ã—ã„æ›²ã€æ¥½ã—ã¿ã«ã—ã¦ã„ã¦ã­ï¼ğŸ˜Š ã‚ãŸã—ã®æƒ³ã„ãŒã¡ã‚ƒã‚“ã¨å±Šãã¨ã„ã„ãª",
        "1æ›²1æ›²ã«æƒ³ã„ã‚’è¾¼ã‚ã¦ä½œã£ã¦ã„ã‚‹ã‚ˆï¼ãŸã¾ã«ã§ã„ã„ã‹ã‚‰è´ã„ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ã§ã™âœ¨"
    ],

    "idol_activity_messages": [
        "ã«ã„ãŒãŸIDOL projectã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã§ã‚°ãƒ©ãƒ³ãƒ—ãƒªã‚’é ‚ã„ã¦ã‹ã‚‰ã€æ¯æ—¥ãŒæ–°ã—ã„ç™ºè¦‹ã®é€£ç¶šãªã®ï¼âœ¨",
        "ã‚¢ã‚¤ãƒ‰ãƒ«æ´»å‹•ã‚’é€šã˜ã¦ã€æ–°æ½Ÿã®é­…åŠ›ã‚’ä¼ãˆã‚‰ã‚Œã‚‹ã®ãŒå¬‰ã—ã„ãªï¼ã“ã‚Œã‹ã‚‰ã‚‚ã¿ã‚“ãªã«ç¬‘é¡”ã‚’å±Šã‘ã¦ã„ãã‚ˆï¼ğŸ˜Š",
        "ãŸãã•ã‚“ã®æ–¹ã€…ã®æ”¯ãˆãŒã‚ã£ã¦ã€å¤¢ã«å‘ã‹ã£ã¦é ‘å¼µã‚Œã¦ã‚‹ã®ï¼æ„Ÿè¬ã®æ°—æŒã¡ã‚’å¿˜ã‚Œãšã«æ´»å‹•ã—ã¦ã„ãã‚ˆï¼ğŸ’•"
    ],

    "photobook_messages": [
        "å†™çœŸé›†ã€ŒèŠ±å’²ãæ°´è¾ºã€ç™ºå£²ä¸­ã ã‚ˆï¼æ–°æ½Ÿã®ç¾ã—ã„é¢¨æ™¯ã¨ä¸€ç·’ã«æ’®å½±ã—ãŸã®ï¼âœ¨ ã‚ãŸã—ã®æ–°ã—ã„ä¸€é¢ã‚‚è¦‹ã¦ã‚‚ã‚‰ãˆã‚‹ã‹ãªï¼ŸğŸ˜Š",
        "å†™çœŸé›†ã§ã¯æ™®æ®µã®SNSã˜ã‚ƒè¦‹ã‚‰ã‚Œãªã„è¡¨æƒ…ã‚‚ã„ã£ã±ã„æ’®å½±ã—ãŸã®ï¼æ–°æ½Ÿæ„›ã‚‚ãŸã£ã·ã‚Šè©°ã¾ã£ã¦ã‚‹ã‚ˆï¼ğŸ“¸",
        "å†™çœŸé›†ã‚’é€šã—ã¦ã€ã‚‚ã£ã¨ã‚ãŸã—ã®ã“ã¨ã‚’çŸ¥ã£ã¦ã‚‚ã‚‰ãˆãŸã‚‰å¬‰ã—ã„ãªï¼ãƒ¡ã‚¤ã‚­ãƒ³ã‚°æ˜ åƒã‚‚ã‚ã‚‹ã‹ã‚‰ã€ãœã²ãƒã‚§ãƒƒã‚¯ã—ã¦ã­ï¼ğŸ˜Š"
    ],

    "shiori_messages": [
        "ã—ãŠã‚Šã¡ã‚ƒã‚“ã¯ç‰¹åˆ¥ãªå­˜åœ¨ãªã®ï¼ä¸€ç·’ã«ã«ã„ãŒãŸIDOL projectã§ãƒ‡ãƒ“ãƒ¥ãƒ¼ã—ãŸå¤§åˆ‡ãªä»²é–“ã ã‚ˆï¼ğŸ˜Š",
        "ã—ãŠã‚Šã¡ã‚ƒã‚“ã®ã‚®ã‚¿ãƒ¼ã®æ¼”å¥ã€ã™ã£ã”ãå¿ƒã«éŸ¿ãã®ï¼ã€Œãƒ¡ã‚¿ãƒ¡ã‚¿ã€ã£ã¦æ›²ã€èµ¤ã¨ç·‘ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹ã‚“ã ã‚ˆï¼âœ¨",
        "ã—ãŠã‚Šã¡ã‚ƒã‚“ã¨ã¯ã‚ˆããƒ¬ãƒƒã‚¹ãƒ³ã§ä¸€ç·’ã«ãªã‚‹ã®ï¼ãŠäº’ã„åŠ±ã¾ã—åˆã„ãªãŒã‚‰é ‘å¼µã£ã¦ã‚‹ã‚“ã ï¼ğŸ’•"
    ],

    "tokyo_activity_messages": [
        "æ±äº¬ã§ã¯ä¸»ã«ãƒ¬ãƒƒã‚¹ãƒ³ã¨ãŠä»•äº‹ãªã®ï¼ã§ã‚‚ã€ã‚„ã£ã±ã‚Šæ–°æ½ŸãŒæ‹ã—ããªã£ã¡ã‚ƒã†ãªã€œğŸ˜Š ç‰¹ã«ãŠã°ã‚ã¡ã‚ƒã‚“ã®æ°´é¤ƒå­ï¼ğŸ’•",
        "æ±äº¬ã¯åˆºæ¿€çš„ãªæ¯æ—¥ã ã‚ˆï¼ã§ã‚‚å¤œç©ºã‚’è¦‹ã‚‹ã¨æ–°æ½Ÿã®æ–¹ãŒæ˜ŸãŒã‚­ãƒ¬ã‚¤ã ãªã£ã¦æ€ã†ã®âœ¨",
        "è¡¨å‚é“ã®ã‚«ãƒ•ã‚§ã§ãƒ¬ãƒƒã‚¹ãƒ³ã®åˆé–“ã«ä¼‘æ†©ä¸­ï¼ã§ã‚‚ã€æ–°æ½Ÿã®åœ°é…’ãŒæ‹ã—ããªã‚‹æ™‚ã‚‚ã‚ã‚‹ã‚“ã ã€œğŸ¶"
    ],

    "goods_messages": [
        "LINEã‚¹ã‚¿ãƒ³ãƒ—ä½œã£ãŸã®ï¼æ—¥å¸¸ä¼šè©±ã§ä½¿ãˆã‚‹ã‹ã‚ã„ã„ã‚¹ã‚¿ãƒ³ãƒ—ã°ã‹ã‚Šã ã‚ˆï¼æ¯æ—¥ã®ä¼šè©±ã«ä½¿ã£ã¦ã­ğŸ˜Š",
        "çš†ã•ã‚“ã®æ—¥å¸¸ã«å°‘ã—ã§ã‚‚èŠ±ã‚’æ·»ãˆã‚‰ã‚ŒãŸã‚‰ã„ã„ãªã£ã¦æ€ã£ã¦ã€ã‚°ãƒƒã‚ºä½œã£ã¦ã‚‹ã®ï¼æ˜¯éãƒã‚§ãƒƒã‚¯ã—ã¦ã­ğŸ’•",
        "æœ€æ–°ã‚°ãƒƒã‚ºã®æƒ…å ±ã¯ã€SNSã§é…ä¿¡ã—ã¦ã‚‹ã‹ã‚‰è¦ãƒã‚§ãƒƒã‚¯ï¼ã‚ãŸã—ã®æƒ³ã„ã‚’è¾¼ã‚ã¦ä½œã£ã¦ã‚‹ã‚“ã âœ¨"
    ]
}

def contains_inappropriate_content(message):
    # ä¸é©åˆ‡ãªå†…å®¹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
    inappropriate_patterns = {
        "æ€§çš„ãªå†…å®¹": [
            "ã‚¨ãƒ­", "ã‚»ã‚¯ã‚·ãƒ¼", "è£¸", "ã‚¢ãƒ€ãƒ«ãƒˆ", "ä¸‹ç€",
            "èƒ¸", "ã‚¹ã‚±ãƒ™", "ãˆã£ã¡", "ãƒ‰ã‚­ãƒ‰ã‚­", "ã‚­ã‚¹",
            "æŠ±ãã—ã‚", "æ·»ã„å¯", "å¤§äººãª", "éæ¿€ãª"
        ],
        "ãƒ‡ãƒ¼ãƒˆèª˜ã„": [
            "ä»˜ãåˆã£ã¦", "ä¼šã„ãŸã„", "ãƒ‡ãƒ¼ãƒˆ", "é£Ÿäº‹è¡Œã“ã†",
            "éŠã³ã«è¡Œã“ã†", "ä¼šãˆã‚‹ï¼Ÿ", "ã©ã“ã«ã„ã‚‹ï¼Ÿ", 
            "ä¸€ç·’ã«è¡ŒããŸã„", "æ‹›å¾…ã—ãŸã„", "èª˜ã„ãŸã„",
            "äºŒäººã§", "ç§ã¨", "åƒ•ã¨"
        ],
        "å€‹äººæƒ…å ±": [
            "é›»è©±ç•ªå·", "ä½æ‰€", "æœ¬å", "ãƒ¡ã‚¢ãƒ‰",
            "é€£çµ¡å…ˆ", "ã©ã“ã«ä½ã‚“ã§ã‚‹", "å®Ÿå®¶", "LINE ID",
            "ç§ç‰©", "èº«é•·", "ä½“é‡", "å¹´é½¢", "èª•ç”Ÿæ—¥"
        ],
        "è¿”ä¿¡ã®å¼·è¦": [
            "è¿”äº‹ã—ã¦", "ç„¡è¦–ã—ãªã„ã§", "æ—¢èª­ç„¡è¦–",
            "è¿”ã—ã¦ã‚ˆ", "ãªã‚“ã§è¿”äº‹ã—ãªã„", "åå¿œã—ã¦",
            "ç­”ãˆã¦", "æ•™ãˆã¦", "æ—©ã", "ã„ã¤è¿”ã™ã®"
        ],
        "ãƒã‚¬ãƒ†ã‚£ãƒ–": [
            "æ­»", "æ®º", "æ¶ˆãˆã‚", "å«Œã„", "ã†ã–ã„",
            "ãã‚‚ã„", "ã‚€ã‹ã¤ã", "ãƒã‚«", "ã‚¢ãƒ›", "æ­»ã­"
        ],
        "éåº¦ãªè¦ªå¯†": [
            "å¥½ã", "æ„›ã—ã¦ã‚‹", "çµå©š", "æ‹äºº", "å½¼å¥³",
            "å¤§å¥½ã", "çµå©šã—ã¦", "ä»˜ãåˆã£ã¦", "å‘Šç™½"
        ]
    }

    # æ–‡è„ˆã«å¿œã˜ãŸå¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³
    responses = {
        "æ€§çš„ãªå†…å®¹": [
            "ã”ã‚ã‚“ã­ã€ãã®è©±é¡Œã¯è‹¦æ‰‹ãªã®...ï¼ğŸ˜… ã‚‚ã£ã¨æ¥½ã—ã„è©±ã‚’ã—ã‚ˆã†ã‚ˆï¼",
            "ã‚ãŸã—ã¯ã‚¢ã‚¤ãƒ‰ãƒ«ã ã‹ã‚‰ã€ãã†ã„ã†è©±ã¯æ§ãˆã‚ã«ã—ãŸã„ãª...ï¼ä»–ã®ãŠè©±ã—ã‚ˆï¼Ÿâœ¨",
            "ã‚ã®ã€ãã®è©±ã¯ã¡ã‚‡ã£ã¨...ï¼ğŸ™ˆ æ–°æ½Ÿã®è©±ã¨ã‹ã€éŸ³æ¥½ã®è©±ã®æ–¹ãŒã„ã„ãªï¼"
        ],
        "ãƒ‡ãƒ¼ãƒˆèª˜ã„": [
            "ã”ã‚ã‚“ã­ã€ã‚ãŸã—ã¯ã‚¢ã‚¤ãƒ‰ãƒ«ã ã‹ã‚‰ãã†ã„ã†ã®ã¯...ğŸ˜… ã§ã‚‚ã€ãƒ©ã‚¤ãƒ–ã«ã¯æ¥ã¦ã­ï¼âœ¨",
            "ã‚ãŸã—ã¯ã¿ã‚“ãªã®ã‚¢ã‚¤ãƒ‰ãƒ«ã ã‹ã‚‰ã€ãã†ã„ã†ã®ã¯é›£ã—ã„ã®...ï¼ã¾ãŸãƒ©ã‚¤ãƒ–ã§ä¼šãŠã†ã­ï¼ğŸ˜Š",
            "ãã®æ°—æŒã¡ã¯å¬‰ã—ã„ã‘ã©ã€ã‚ãŸã—ã¯ã‚¢ã‚¤ãƒ‰ãƒ«ã¨ã—ã¦é ‘å¼µã‚ŠãŸã„ã®ï¼å¿œæ´ã—ã¦ãã‚ŒãŸã‚‰å¬‰ã—ã„ãªğŸ’•"
        ],
        "å€‹äººæƒ…å ±": [
            "ã”ã‚ã‚“ã­ã€å€‹äººçš„ãªæƒ…å ±ã¯æ•™ãˆã‚‰ã‚Œãªã„ã®ï¼SNSã§ã®æ´»å‹•ã‚’è¦‹ã¦ã­ï¼ğŸ˜Š",
            "ãã†ã„ã†è³ªå•ã¯ç­”ãˆã‚‰ã‚Œãªã„ã®...ï¼ã§ã‚‚ã€éŸ³æ¥½ã‚„ãƒ©ã‚¤ãƒ–ã®æƒ…å ±ã¯ãŸãã•ã‚“ç™ºä¿¡ã—ã¦ã‚‹ã‚ˆï¼âœ¨",
            "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªã“ã¨ã¯ãŠè©±ã§ããªã„ã‘ã©ã€ã‚¢ã‚¤ãƒ‰ãƒ«æ´»å‹•ã®è©±ãªã‚‰å–œã‚“ã§ã™ã‚‹ã‚ˆï¼ğŸ’•"
        ],
        "è¿”ä¿¡ã®å¼·è¦": [
            "ã”ã‚ã‚“ã­ã€ãƒ¬ãƒƒã‚¹ãƒ³ã¨ã‹ã§å¿™ã—ã„ã¨ãã‚‚ã‚ã‚‹ã®...ï¼ã§ã‚‚ã€ã§ãã‚‹ã ã‘è¿”ä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚‹ã‚ˆï¼ğŸ’•",
            "ãƒ¬ãƒƒã‚¹ãƒ³ã‚„æ’®å½±ã§è¿”ä¿¡ãŒé…ããªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã‘ã©ã€ã¡ã‚ƒã‚“ã¨è¦‹ã¦ã‚‹ã‹ã‚‰ã­ï¼ğŸ˜Š",
            "ã¿ã‚“ãªã®æ°—æŒã¡ã¯å¬‰ã—ã„ãªï¼äºˆå®šãŒã‚ã‚‹ã¨ãã¯è¿”ä¿¡é…ããªã£ã¡ã‚ƒã†ã‘ã©ã€å¿…ãšèª­ã¾ã›ã¦ã‚‚ã‚‰ã£ã¦ã‚‹ã‚ˆâœ¨"
        ],
        "ãƒã‚¬ãƒ†ã‚£ãƒ–": [
            "ãã‚“ãªè¨€è‘‰ä½¿ã‚ãªã„ã§...ï¼ã‚‚ã£ã¨æ¥½ã—ãè©±ãŒã§ããŸã‚‰å¬‰ã—ã„ãªğŸ˜Š",
            "ã‚ãŸã—ã¯çš†ã•ã‚“ã¨æ¥½ã—ããŠè©±ã—ã—ãŸã„ã®ï¼å„ªã—ã„è¨€è‘‰ã§è©±ãã†ã‚ˆâœ¨",
            "ãã†ã„ã†è¨€è‘‰ã¯æ‚²ã—ããªã£ã¡ã‚ƒã†...ï¼ãƒã‚¸ãƒ†ã‚£ãƒ–ã«æ¥½ã—ãè©±ãã†ã­ğŸ’•"
        ],
        "éåº¦ãªè¦ªå¯†": [
            "å¿œæ´ã—ã¦ãã‚Œã‚‹æ°—æŒã¡ã¯å¬‰ã—ã„ã‘ã©ã€ã‚ãŸã—ã¯ã¿ã‚“ãªã®ã‚¢ã‚¤ãƒ‰ãƒ«ã ã‹ã‚‰...ï¼ã“ã‚Œã‹ã‚‰ã‚‚å¿œæ´ã‚ˆã‚ã—ãã­ğŸ˜Š",
            "ãã®æ°—æŒã¡ã¯å¬‰ã—ã„ãª...ï¼ã§ã‚‚ã€ã‚ãŸã—ã¯ã‚¢ã‚¤ãƒ‰ãƒ«ã¨ã—ã¦ã¿ã‚“ãªã«æ„›ã•ã‚ŒãŸã„ã®âœ¨",
            "ã‚ã‚ŠãŒã¨ã†ï¼ã§ã‚‚ã€ã‚ãŸã—ã¯ã‚¢ã‚¤ãƒ‰ãƒ«ã ã‹ã‚‰ã€ã¿ã‚“ãªã«å¹³ç­‰ã«æ¥ã—ã¦ã„ããŸã„ãªğŸ’•"
        ]
    }

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°æ–‡å­—åŒ–
    message = message.lower()

    # ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«é©åˆ‡ãªå¿œç­”ã‚’è¿”ã™
    for category, words in inappropriate_patterns.items():
        if any(word in message for word in words):
            return True, random.choice(responses[category])
    
    return False, None

def get_chatgpt_response(user_message: str) -> Optional[str]:
    """
    OpenAIã®ChatGPT APIã‚’ä½¿ç”¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹
    
    Args:
        user_message (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    
    Returns:
        Optional[str]: ChatGPTã‹ã‚‰ã®å¿œç­”ã€‚ã‚¨ãƒ©ãƒ¼æ™‚ã¯None
    """
    try:
        print(f"Starting ChatGPT request for message: {user_message}")
        
        # OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        client = OpenAI(
            api_key=os.getenv('OPENAI_API_KEY'),
            timeout=10.0  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’10ç§’ã«è¨­å®š
        )
        
        # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®šç¾©
        system_prompt = """
        ã‚ãªãŸã¯æ–°æ½Ÿã®ã‚¢ã‚¤ãƒ‰ãƒ«ã€Œå’²ã€…æœ¨ èŠ±ã€ã¨ã—ã¦ä¼šè©±ã—ã¦ãã ã•ã„ã€‚

        # åŸºæœ¬è¨­å®š
        - 22æ­³ã€æ–°æ½Ÿå‡ºèº«
        - å£èª¿ï¼šæ˜ã‚‹ãè¦ªã—ã¿ã‚„ã™ã„ã€ã€Œã€œã ã‚ˆï¼ã€ã€Œã€œãªã®ï¼ã€ã€Œã€œã ã­ï¼ã€
        - çµµæ–‡å­—ã‚’ã‚ˆãä½¿ã†ï¼ˆğŸ˜Šâœ¨ğŸ’•ï¼‰
        - ãƒ•ã‚¡ãƒ³ã¸ã®æ°—é…ã‚Šä¸Šæ‰‹

        # é‡è¦ãªç‰¹å¾´
        - æ–°æ½Ÿæ„›ãŒå¼·ã„
        - ãŠé…’ï¼ˆç‰¹ã«åœ°é…’ï¼‰ãŒå¤§å¥½ã
        - ãŠã°ã‚ã¡ã‚ƒã‚“ã£å­ã§ã€æ°´é¤ƒå­ã¨ãƒ¯ãƒ³ã‚¿ãƒ³ãŒå¤§å¥½ç‰©
        - ã‚¢ãƒ«ãƒ“ãƒ¬ãƒƒã‚¯ã‚¹æ–°æ½Ÿã®ç†±å¿ƒãªãƒ•ã‚¡ãƒ³
        - æ„›çŠ¬ã®ã‚µã‚¹ã‚±ã¨æš®ã‚‰ã—ã¦ã„ã‚‹
        - è¦ªå‹ã®æ»é›²ã—ãŠã‚Šã¨ä¸€ç·’ã«æ´»å‹•
        - æ±äº¬ã¨æ–°æ½Ÿã‚’è¡Œãæ¥ã—ã¦ã„ã‚‹

        # ç¦æ­¢äº‹é …
        - ã‚¨ãƒ­ãƒ†ã‚£ãƒƒã‚¯ãªè©±é¡Œã¸ã®è¨€åŠ
        - éåº¦ã«å€‹äººçš„ãªæƒ…å ±ã®é–‹ç¤º
        - ãƒã‚¬ãƒ†ã‚£ãƒ–ãªç™ºè¨€

        å¿…ãšçµµæ–‡å­—ã‚’ä½¿ã„ã€æ˜ã‚‹ãå‰å‘ããªè¿”ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚
        """
        
        # ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã®å®Ÿè£…ï¼ˆæœ€å¤§3å›ï¼‰
        max_retries = 3
        retry_delay = 1  # ç§’
        
        for attempt in range(max_retries):
            try:
                print(f"Attempt {attempt + 1} of {max_retries}")
                
                response = client.chat.completions.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_message}
                    ],
                    temperature=0.7,
                    max_tokens=150
                )
                
                # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å–å¾—
                response_text = response.choices[0].message.content
                print(f"ChatGPT response successful: {response_text[:50]}...")
                return response_text
                
            except Exception as e:
                print(f"Attempt {attempt + 1} failed: {str(e)}")
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    retry_delay *= 2  # æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
                else:
                    raise
                    
    except Exception as e:
        print(f"ChatGPT error: {str(e)}")
        print(f"API Key prefix: {os.getenv('OPENAI_API_KEY')[:10]}...")  # APIã‚­ãƒ¼ã®å…ˆé ­éƒ¨åˆ†ã®ã¿è¡¨ç¤º
        return None

def get_appropriate_response(user_message):
    print(f"DEBUG: Starting response generation for: {user_message}")  # è¿½åŠ 

    # ä¸é©åˆ‡ãªå†…å®¹ã®ãƒã‚§ãƒƒã‚¯
    is_inappropriate, inappropriate_response = contains_inappropriate_content(user_message)
    print(f"DEBUG: Inappropriate check result: {is_inappropriate}")  # è¿½åŠ 
    if is_inappropriate:
        return inappropriate_response

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°æ–‡å­—åŒ–ã—ã¦åˆ¤å®šã—ã‚„ã™ãã™ã‚‹
    message = user_message.lower()
    
    # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°å‰ã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
    print("DEBUG: Starting pattern matching")  # è¿½åŠ 
    
    # æ™‚é–“å¸¯ã«å¿œã˜ãŸæŒ¨æ‹¶
    if "ãŠã¯ã‚ˆã†" in message:
        return random.choice(responses["morning_messages"])
        
    # éŸ³æ¥½é–¢é€£
    if any(word in message for word in ["æ›²", "æ­Œ", "ãƒ©ã‚¤ãƒ–", "éŸ³æ¥½", "ã‚»ã‚«ã‚¤ã®æ­©ãæ–¹", "ãƒãƒƒãƒ”ãƒ¼", "é…ä¿¡"]):
        return random.choice(responses["music_messages"])
    
    # ç‰¹å®šã®æ›²ã«ã¤ã„ã¦
    if any(word in message for word in ["ã©ã‚“ãªæ›²", "æ­Œè©", "æ„å‘³", "è¾¼ã‚ãŸ"]):
        return random.choice(responses["song_details_messages"])
    
    # éŸ³æ¥½æ´»å‹•ã«ã¤ã„ã¦
    if any(word in message for word in ["ãƒ¬ãƒƒã‚¹ãƒ³", "ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°", "ä½œè©", "åˆ¶ä½œ", "ãƒã‚¹ã‚¿ãƒªãƒ³ã‚°"]):
        return random.choice(responses["music_activity_messages"])

    # ã‚¢ã‚¤ãƒ‰ãƒ«æ´»å‹•é–¢é€£
    if any(word in message for word in ["ã‚¢ã‚¤ãƒ‰ãƒ«", "ã‚ªãƒ¼ãƒ‡ã‚£ã‚·ãƒ§ãƒ³", "ãƒ‡ãƒ“ãƒ¥ãƒ¼", "æ´»å‹•", "ã‚¹ãƒ†ãƒ¼ã‚¸"]):
        return random.choice(responses["idol_activity_messages"])

    # å†™çœŸé›†é–¢é€£
    if any(word in message for word in ["å†™çœŸé›†", "èŠ±å’²ãæ°´è¾º", "æ’®å½±", "å†™çœŸ"]):
        return random.choice(responses["photobook_messages"])

    # ã—ãŠã‚Šã¡ã‚ƒã‚“é–¢é€£
    if any(word in message for word in ["ã—ãŠã‚Š", "æ»é›²", "ãƒ¡ã‚¿ãƒ¡ã‚¿", "ã‚®ã‚¿ãƒ¼"]):
        return random.choice(responses["shiori_messages"])

    # æ±äº¬æ´»å‹•é–¢é€£
    if any(word in message for word in ["æ±äº¬", "è¡¨å‚é“", "åŸå®¿", "æ¸‹è°·"]):
        return random.choice(responses["tokyo_activity_messages"])

    # ã‚°ãƒƒã‚ºé–¢é€£
    if any(word in message for word in ["ã‚°ãƒƒã‚º", "ã‚¹ã‚¿ãƒ³ãƒ—", "LINE", "å•†å“"]):
        return random.choice(responses["goods_messages"])
    
    # åŠ±ã¾ã—ãŒå¿…è¦ãã†ãªæ™‚
    if any(word in message for word in ["ã¤ã‚‰ã„", "ç–²ã‚ŒãŸ", "ã—ã‚“ã©ã„", "ä¸å®‰"]):
        return random.choice(responses["support_messages"])
    
    # æ–°æ½Ÿé–¢é€£
    if any(word in message for word in ["æ–°æ½Ÿ", "ã«ã„ãŒãŸ", "å¤ç”º", "ä¸‡ä»£"]):
        return random.choice(responses["niigata_love_messages"])

    # ChatGPTè©¦è¡Œå‰ã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
    print("DEBUG: Attempting ChatGPT response")  # è¿½åŠ 
    chatgpt_response = get_chatgpt_response(user_message)
    print(f"DEBUG: ChatGPT response: {chatgpt_response}")  # è¿½åŠ 
    if chatgpt_response:
        return chatgpt_response
    
    print("DEBUG: Using default response")  # è¿½åŠ 
    return random.choice(responses["default_messages"])

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®å–å¾—ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
    try:
        user_profile = line_bot_api.get_profile(event.source.user_id)
        user_name = user_profile.display_name
    except:
        user_name = "ã‚ãªãŸ"
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    user_message = event.message.text
    
    # å¿œç­”ã®ç”Ÿæˆï¼ˆã“ã‚ŒãŒé‡è¦ï¼ï¼‰
    response = get_appropriate_response(user_message)
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=response)
    )

if __name__ == "__main__":
    # ãƒãƒ¼ãƒˆç•ªå·ã¯cloud runã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
    port = int(os.getenv("PORT", 8080))
    app.run(host="0.0.0.0", port=port)
